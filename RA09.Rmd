---
title: "RA09"
output: html_document
date: "2023-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
install.packages("haven")
install.packages("tidyverse")
install.packages("gt")
install.packages("gtsummary")
install.packages("modelsummary")
install.packages("estimatr")
```
```{r}
library(haven)
library(tidyverse)
library(gt)
library(gtsummary)
library(estimatr)
library(modelsummary)
```


```{r}

df_raw <- haven::read_dta("smallmo.dta")
head(df_raw)
names(df_raw)
glimpse(df_raw)
```

#ここで表作る。
```{r}
View(df_raw)
```
```{r}

# df_raw |>
#   mutate(area)
# df_rwa1 <- df_raw |> 
#  select(area,north,centre,south)
```
```{r}
# table1
# for(i in 0:1){
#   df_raw |> 
#     mutate(
#       area2 = case_match(south,
#         0 ~ "North/Center",
#         1 ~ "South",
#         .default = NA
#       )
#     ) |> 
#     filter(grade == i) |> 
#     select (area2, female, immigrants_broad, dad_midedu, mom_employed, answers_math_pct, answers_ital_pct,
#             clsize_snv, our_CHEAT_math, our_CHEAT_ital) |>
#   filter(!is.na(our_CHEAT_math) & !is.na(our_CHEAT_ital)) |> 
#     tbl_summary(
#       by = area2,
#       statistic = list(all_continuous()~"{mean} ({sd})")
#       ) |> 
#     add_overall()}

make_table <- function(i){
  df_raw |> 
    mutate(
      area2 = case_match(south,
        0 ~ "North/Center",
        1 ~ "South",
        .default = NA
      )
    ) |> 
    filter(grade == i) |> 
    select (area2, female, immigrants_broad, dad_midedu, mom_employed, answers_math_pct, answers_ital_pct,
            clsize_snv, our_CHEAT_math, our_CHEAT_ital) |>
  filter(!is.na(our_CHEAT_math) & !is.na(our_CHEAT_ital)) |> 
    tbl_summary(
      by = area2,
      statistic = list(all_continuous()~"{mean} ({sd})")
      ) |> 
    add_overall() #error
}
```


```{r}
for (i in 0:1) {
  eval(parse(text=paste("table_grade",i,"<- make_table(",i,")",sep="")))
}

# 表をつなげる
tbl_merge(list(table_grade1, table_grade0),
          tab_spanner = c("**Grade2**", "**Grade5**"))
```



```{r}
ols <- function(data,outcome){
  result <-
  data |> 
    rename(y = outcome) |> 
    mutate(clsize_new = clsize_snv/10) |> 
    lm_robust(y ~ 
                    clsize_new + students + 
                    students2 + 
                    m_female + female + immigrants_broad +
                    dad_lowedu + dad_midedu + dad_highedu +
                    mom_employed + mom_unemp + mom_housew +
                    enrol_ins_snv + factor(region), 
                  fixed_effects =~ factor(survey) + factor(grade) ,
                  clusters = clu,
                  data = _,
                  se_type = "stata")
  return(result)
}
```

データ整形(North/Center か South)
```{r}
df_north_center <- df_raw |> filter(south==0)
df_south <- df_raw |> filter(south==1)
```

#table2 PanelA (ols)
```{r}
ols2A_1 <- ols (df_raw, "answers_math_std")
ols2A_2 <- ols (df_north_center, "answers_math_std")
ols2A_3 <- ols (df_south, "answers_math_std")
```

```{r}
table2A_ols <-  list(ols2A_1, ols2A_2, ols2A_3)
msummary(table2A_ols, 
         coef_omit = -1,
         coef_rename = c("clsize_new" = "Class size"),
         gof_map = c("nobs"),
         )
```

#table2 PanelB (ols)
```{r}
ols2B_1 <- ols (df_raw, "answers_ital_std")
ols2B_2 <- ols (df_north_center, "answers_ital_std")
ols2B_3 <- ols (df_south, "answers_ital_std")
```

```{r}
table2B_ols <-  list(ols2B_1, ols2B_2, ols2B_3)
msummary(table2B_ols, 
         coef_omit = -1,
         coef_rename = c("clsize_new" = "Class size"),
         gof_map = c("nobs"),
         )
```

#table3 PanelA (ols)
```{r}
ols3A_1 <- ols (df_raw, "our_CHEAT_math")
ols3A_2 <- ols (df_north_center, "our_CHEAT_math")
ols3A_3 <- ols (df_south, "our_CHEAT_math")
```

```{r}
table3A_ols <-  list(ols3A_1, ols3A_2, ols3A_3)
msummary(table3A_ols, 
         coef_omit = -1,
         coef_rename = c("clsize_new" = "Class size"),
         gof_map = c("nobs"),
         )
```

#table3 PanelB (ols)
```{r}
ols3B_1 <- ols (df_raw, "our_CHEAT_ital")
ols3B_2 <- ols (df_north_center, "our_CHEAT_ital")
ols3B_3 <- ols (df_south, "our_CHEAT_ital")
```

```{r}
table3B_ols <-  list(ols3B_1, ols3B_2, ols3B_3)
msummary(table3B_ols, 
         coef_omit = -1,
         coef_rename = c("clsize_new" = "Class size"),
         gof_map = c("nobs"),
         )
```


